name: release-merged

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  tag-and-release:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # 5.0.1
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Set up Dart
        uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1.7.1

      - name: Resolve version from pubspec via cider
        id: version
        run: |
          dart pub global activate cider
          version=$(dart pub global run cider version | tr -d '[:space:]')
          if [[ -z "$version" ]]; then
            echo "Failed to read version from pubspec.yaml" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"

      - name: Build changelog
        id: changelog
        run: |
          git fetch --tags
          previous_tag=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || true)
          range="${previous_tag:+$previous_tag..HEAD}"
          git log --no-merges --pretty='- %s (%h)' ${range:+$range} > release_notes.md
          echo "note-file=release_notes.md" >> "$GITHUB_OUTPUT"
          echo "previous-tag=$previous_tag" >> "$GITHUB_OUTPUT"

      - name: Create tag
        uses: mathieudutour/github-tag-action@a22cf08638b34d5badda920f9daf6e72c477b07b # v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: ${{ steps.version.outputs.tag }}

      - name: Publish GitHub release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2.4.2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          body_path: ${{ steps.changelog.outputs.note-file }}
